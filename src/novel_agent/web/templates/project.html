{% extends "base.html" %}

{% block title %}{{ project_name }} - ç•ªèŒ„å°è¯´Agent{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title" id="projectTitle">{{ project_name }}</h1>
        <div style="color: var(--text-secondary); margin-top: 4px;">
            <span id="currentStage">åŠ è½½ä¸­...</span> Â·
            <span id="currentProgress">-</span>
        </div>
    </div>
    <div class="page-actions">
        <button class="btn btn-secondary" onclick="window.location.href='/'">
            â† è¿”å›
        </button>
    </div>
</div>

<div class="editor-container">
    <!-- æ–‡ä»¶æ ‘ -->
    <div class="file-tree">
        <div class="file-tree-title">ğŸ“ æ–‡ä»¶</div>
        <div id="fileTree">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘å™¨ä¸»åŒºåŸŸ -->
    <div class="editor-main">
        <div class="editor-toolbar">
            <div class="editor-tabs">
                <button class="editor-tab active" onclick="switchEditorTab('edit')">ğŸ“ ç¼–è¾‘</button>
                <button class="editor-tab" onclick="switchEditorTab('preview')">ğŸ‘ï¸ é¢„è§ˆ</button>
            </div>
            <div style="display: flex; gap: 8px; align-items: center;">
                <span id="autosaveIndicator"
                    style="font-size: 12px; color: var(--text-secondary); margin-right: 8px;"></span>
                <span id="wordCount" style="color: var(--text-secondary); font-size: 13px;"></span>
                <button class="btn btn-success btn-sm" onclick="saveCurrentFile()">
                    ğŸ’¾ ä¿å­˜
                </button>
            </div>
        </div>
        <div class="editor-content">
            <textarea id="editorTextarea" class="editor-textarea" placeholder="é€‰æ‹©å·¦ä¾§æ–‡ä»¶å¼€å§‹ç¼–è¾‘..."
                oninput="updateWordCount()"></textarea>
            <div id="previewContent" class="preview-content" style="display: none;"></div>
        </div>
    </div>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="control-panel">
        <div class="control-section">
            <div class="control-title">ğŸš€ ç”Ÿæˆæ§åˆ¶</div>
            <div class="stage-list">
                <div class="stage-item">
                    <span>ğŸ“‹ åˆ†æçµæ„Ÿ</span>
                    <button class="btn btn-sm btn-secondary" onclick="generateMeta()">ç”Ÿæˆ</button>
                </div>
                <!-- ... other stages ... -->
                <div class="stage-item">
                    <span>ğŸ“– æ€»çº²</span>
                    <button class="btn btn-sm btn-secondary" onclick="generateMaster()">ç”Ÿæˆ</button>
                </div>
                <div class="stage-item">
                    <span>ğŸ“‘ ç²—çº²</span>
                    <button class="btn btn-sm btn-secondary" onclick="generateVolume()">ç”Ÿæˆ</button>
                </div>
                <div class="stage-item">
                    <span>âœï¸ æ­£æ–‡</span>
                    <button class="btn btn-sm btn-primary" onclick="showStreamGenModal()">æµå¼ç”Ÿæˆ</button>
                </div>
                <div class="stage-item">
                    <span>âœ¨ æ¶¦è‰²</span>
                    <button class="btn btn-sm btn-secondary" onclick="polishCurrent()">æ¶¦è‰²å½“å‰</button>
                </div>
            </div>
        </div>

        <div class="control-section">
            <div class="control-title">ğŸ“Š ç”Ÿæˆè¿›åº¦</div>

            <!-- å­—æ•°ç›®æ ‡è¿›åº¦ -->
            <div id="goalProgress" style="margin-bottom: 16px;"></div>

            <div class="progress-container">
                <div class="progress-label">
                    <span id="progressLabel">å°±ç»ª</span>
                    <span id="progressPercent"></span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>
            <div id="streamOutput"
                style="margin-top: 12px; max-height: 200px; overflow-y: auto; font-size: 13px; color: var(--text-secondary); display: none;">
            </div>
        </div>

        <div class="control-section">
            <div class="control-title">âš¡ å¿«é€Ÿæ“ä½œ</div>
            <button class="btn btn-secondary btn-sm" style="width: 100%; margin-bottom: 8px;"
                onclick="refreshProject()">
                ğŸ”„ åˆ·æ–°
            </button>
            <button class="btn btn-secondary btn-sm" style="width: 100%;" onclick="showAIAssist()">
                ğŸ¤– AIåŠ©æ‰‹
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const projectName = '{{ project_name }}';
</script>
<script>
    {% raw %}
    window.initPage = function () {
        loadProjectDetail(projectName);
        updateGoalProgress(); // åœ¨ app.js ä¸­å®šä¹‰
    };

    function updateWordCount() {
        const text = document.getElementById('editorTextarea').value;
        const count = text.length;
        document.getElementById('wordCount').textContent = count + ' å­—';
    }

    function refreshProject() {
        loadProjectDetail(projectName);
        showToast('å·²åˆ·æ–°');
    }

    // ============ ç”ŸæˆåŠŸèƒ½ ============

    async function generateMeta() {
        const inspiration = prompt('è¯·è¾“å…¥å°è¯´çµæ„Ÿ:');
        if (!inspiration) return;

        updateProgress(10, 'åˆ†æçµæ„Ÿä¸­...');

        try {
            const result = await API.generateMeta(projectName, inspiration);
            updateProgress(100, 'å®Œæˆ');
            showToast('çµæ„Ÿåˆ†æå®Œæˆ');
            refreshProject();

            showModal('åˆ†æç»“æœ', '<div class="preview-content">' + renderMarkdown(result.config) + '</div>');
        } catch (e) {
            updateProgress(0, 'å¤±è´¥');
        }
    }

    async function generateMaster() {
        updateProgress(10, 'ç”Ÿæˆæ€»çº²ä¸­...');

        try {
            const result = await API.generateMaster(projectName, '');
            updateProgress(100, 'å®Œæˆ');
            showToast('æ€»çº²ç”Ÿæˆå®Œæˆ');
            refreshProject();

            showModal('æ€»çº²', '<div class="preview-content">' + renderMarkdown(result.content) + '</div>');
        } catch (e) {
            updateProgress(0, 'å¤±è´¥');
        }
    }

    async function generateVolume() {
        const volumeNum = prompt('ç”Ÿæˆç¬¬å‡ å·?', '1');
        if (!volumeNum) return;

        updateProgress(10, 'ç”Ÿæˆç¬¬' + volumeNum + 'å·ç²—çº²...');

        try {
            const result = await API.generateVolume(projectName, parseInt(volumeNum));
            updateProgress(100, 'å®Œæˆ');
            showToast('ç²—çº²ç”Ÿæˆå®Œæˆ');
            refreshProject();
        } catch (e) {
            updateProgress(0, 'å¤±è´¥');
        }
    }

    // ============ æµå¼ç”Ÿæˆ ============

    function showStreamGenModal() {
        showModal('âœï¸ æµå¼ç”Ÿæˆæ­£æ–‡', `
        <div class="form-group">
            <label class="form-label">ç« èŠ‚ç»†çº² / æç¤ºè¯</label>
            <textarea id="streamPrompt" class="form-textarea" placeholder="è¾“å…¥ç« èŠ‚ç»†çº²æˆ–ä»»æ„æç¤ºè¯..."></textarea>
        </div>
        <div class="form-group">
            <label class="form-label">ç³»ç»Ÿæç¤ºè¯ï¼ˆå¯é€‰ï¼‰</label>
            <textarea id="streamSystem" class="form-textarea" style="min-height: 80px;" placeholder="ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ç½‘æ–‡ä½œå®¶..."></textarea>
        </div>
    `, `
        <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="startStreamGen()">ğŸš€ å¼€å§‹ç”Ÿæˆ</button>
    `);
    }

    async function startStreamGen() {
        const prompt = document.getElementById('streamPrompt').value;
        const systemPrompt = document.getElementById('streamSystem').value;

        if (!prompt) {
            showToast('è¯·è¾“å…¥æç¤ºè¯', 'error');
            return;
        }

        closeModal();

        // æ˜¾ç¤ºè¾“å‡ºåŒºåŸŸ
        const outputEl = document.getElementById('streamOutput');
        outputEl.style.display = 'block';
        outputEl.innerHTML = '';

        const progressLabel = document.getElementById('progressLabel');
        const progressFill = document.getElementById('progressFill');

        progressLabel.textContent = 'ç”Ÿæˆä¸­...';
        progressFill.style.width = '10%';

        try {
            const response = await fetch('/api/stream/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt, system_prompt: systemPrompt })
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullContent = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const text = decoder.decode(value);
                const lines = text.split('\n');

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));

                            if (data.type === 'chunk') {
                                fullContent += data.content;
                                outputEl.innerHTML = '<pre style="white-space: pre-wrap; margin: 0;">' + fullContent + '</pre>';
                                outputEl.scrollTop = outputEl.scrollHeight;

                                // æ›´æ–°è¿›åº¦
                                const progress = Math.min(90, 10 + (fullContent.length / 3000) * 80);
                                progressFill.style.width = progress + '%';
                                progressLabel.textContent = 'å·²ç”Ÿæˆ ' + fullContent.length + ' å­—';
                            } else if (data.type === 'complete') {
                                progressFill.style.width = '100%';
                                progressLabel.textContent = 'å®Œæˆ: ' + data.word_count + ' å­—';

                                // å¡«å…¥ç¼–è¾‘å™¨
                                document.getElementById('editorTextarea').value = fullContent;
                                updateWordCount();
                                showToast('ç”Ÿæˆå®Œæˆï¼');
                            } else if (data.type === 'error') {
                                progressLabel.textContent = 'é”™è¯¯: ' + data.message;
                                showToast(data.message, 'error');
                            }
                        } catch (e) { }
                    }
                }
            }
        } catch (e) {
            progressLabel.textContent = 'è¿æ¥å¤±è´¥';
            showToast('ç”Ÿæˆå¤±è´¥', 'error');
        }
    }

    async function polishCurrent() {
        const content = document.getElementById('editorTextarea').value;
        if (!content) {
            showToast('è¯·å…ˆåœ¨ç¼–è¾‘å™¨ä¸­è¾“å…¥æˆ–é€‰æ‹©å†…å®¹', 'error');
            return;
        }

        updateProgress(10, 'æ¶¦è‰²ä¸­...');

        try {
            const result = await API.generatePolish(projectName, content, 1);
            updateProgress(100, 'å®Œæˆ');

            // æ˜¾ç¤ºå¯¹æ¯”
            showModal('æ¶¦è‰²ç»“æœ', `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div>
                    <h4 style="margin-bottom: 8px;">åŸæ–‡</h4>
                    <div style="background: var(--bg-primary); padding: 12px; border-radius: 8px; max-height: 300px; overflow-y: auto;">
                        ${content.substring(0, 500)}...
                    </div>
                </div>
                <div>
                    <h4 style="margin-bottom: 8px;">æ¶¦è‰²å</h4>
                    <div style="background: var(--bg-primary); padding: 12px; border-radius: 8px; max-height: 300px; overflow-y: auto;">
                        ${result.content.substring(0, 500)}...
                    </div>
                </div>
            </div>
        `, `
            <button class="btn btn-secondary" onclick="closeModal()">å…³é—­</button>
            <button class="btn btn-primary" onclick="applyPolish('${encodeURIComponent(result.content)}')">åº”ç”¨æ¶¦è‰²</button>
        `);
        } catch (e) {
            updateProgress(0, 'å¤±è´¥');
        }
    }

    function applyPolish(encodedContent) {
        document.getElementById('editorTextarea').value = decodeURIComponent(encodedContent);
        updateWordCount();
        closeModal();
        showToast('å·²åº”ç”¨æ¶¦è‰²å†…å®¹');
    }

    function showAIAssist() {
        const selectedText = window.getSelection().toString() ||
            document.getElementById('editorTextarea').value.substring(0, 500);

        showModal('ğŸ¤– AIåŠ©æ‰‹', `
        <div class="form-group">
            <label class="form-label">é€‰ä¸­çš„æ–‡æœ¬</label>
            <textarea id="assistText" class="form-textarea" style="min-height: 100px;">${selectedText}</textarea>
        </div>
        <div class="form-group">
            <label class="form-label">æ“ä½œ</label>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                <button class="btn btn-sm btn-secondary" onclick="aiAssist('æ‰©å†™')">ğŸ“ æ‰©å†™</button>
                <button class="btn btn-sm btn-secondary" onclick="aiAssist('ç¼©å†™')">ğŸ“‰ ç¼©å†™</button>
                <button class="btn btn-sm btn-secondary" onclick="aiAssist('æ¶¦è‰²')">âœ¨ æ¶¦è‰²</button>
                <button class="btn btn-sm btn-secondary" onclick="aiAssist('æ”¹å†™ä¸ºç¬¬ä¸€äººç§°')">ğŸ”„ æ”¹è§†è§’</button>
                <button class="btn btn-sm btn-secondary" onclick="aiAssist('ç»§ç»­å†™')">â¡ï¸ ç»­å†™</button>
            </div>
        </div>
        <div id="assistResult" style="margin-top: 16px; display: none;">
            <label class="form-label">ç»“æœ</label>
            <div id="assistOutput" style="background: var(--bg-primary); padding: 12px; border-radius: 8px; max-height: 200px; overflow-y: auto;"></div>
        </div>
    `, `
        <button class="btn btn-secondary" onclick="closeModal()">å…³é—­</button>
    `);
    }

    async function aiAssist(action) {
        const text = document.getElementById('assistText').value;
        if (!text) return;

        const resultEl = document.getElementById('assistResult');
        const outputEl = document.getElementById('assistOutput');

        resultEl.style.display = 'block';
        outputEl.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

        try {
            const prompt = 'è¯·å¯¹ä»¥ä¸‹æ–‡æœ¬è¿›è¡Œ"' + action + '"æ“ä½œ:\n\n' + text;

            const response = await fetch('/api/stream/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt, system_prompt: 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ç½‘æ–‡ç¼–è¾‘ã€‚' })
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let result = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const text = decoder.decode(value);
                const lines = text.split('\n');

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            if (data.type === 'chunk') {
                                result += data.content;
                                outputEl.innerHTML = '<pre style="white-space: pre-wrap; margin: 0;">' + result + '</pre>';
                            }
                        } catch (e) { }
                    }
                }
            }
        } catch (e) {
            outputEl.innerHTML = '<p style="color: var(--accent-primary);">è¯·æ±‚å¤±è´¥</p>';
        }
    }
    {% endraw %}
</script>
{% endblock %}