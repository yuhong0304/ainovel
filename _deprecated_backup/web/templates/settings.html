{% extends "base.html" %}

{% block title %}è®¾ç½® - ç•ªèŒ„å°è¯´Agent{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">âš™ï¸ è®¾ç½®</h1>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
    <!-- æ¨¡å‹é€‰æ‹© -->
    <div class="card" style="padding: 24px;">
        <h3 style="margin-bottom: 20px;">ğŸ¤– æ¨¡å‹é€‰æ‹©</h3>
        <div class="model-list" id="modelList">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <!-- ç”Ÿæˆå‚æ•° -->
    <div class="card" style="padding: 24px;">
        <h3 style="margin-bottom: 20px;">ğŸ›ï¸ ç”Ÿæˆå‚æ•°</h3>

        <!-- é¢„è®¾æŒ‰é’® -->
        <div style="display: flex; gap: 8px; margin-bottom: 20px;">
            <button class="btn btn-sm btn-secondary" onclick="applyPreset('creative')">ğŸ¨ åˆ›æ„æ¨¡å¼</button>
            <button class="btn btn-sm btn-secondary" onclick="applyPreset('balanced')">âš–ï¸ å¹³è¡¡æ¨¡å¼</button>
            <button class="btn btn-sm btn-secondary" onclick="applyPreset('precise')">ğŸ¯ ç²¾ç¡®æ¨¡å¼</button>
        </div>

        <!-- Temperature -->
        <div class="form-group">
            <label class="form-label">Temperature: <span id="tempValue">0.7</span></label>
            <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7" style="width: 100%;"
                onchange="updateParam('temperature', this.value)">
            <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-muted);">
                <span>ç²¾ç¡® (0)</span><span>åˆ›æ„ (2)</span>
            </div>
        </div>

        <!-- Max Tokens -->
        <div class="form-group">
            <label class="form-label">Max Tokens</label>
            <input type="number" id="maxTokens" class="form-input" value="8192" min="100" max="32000"
                onchange="updateParam('max_tokens', parseInt(this.value))">
        </div>

        <!-- Top-P -->
        <div class="form-group">
            <label class="form-label">Top-P: <span id="topPValue">0.95</span></label>
            <input type="range" id="topP" min="0" max="1" step="0.05" value="0.95" style="width: 100%;"
                onchange="updateParam('top_p', parseFloat(this.value))">
        </div>

        <!-- Top-K -->
        <div class="form-group">
            <label class="form-label">Top-K: <span id="topKValue">40</span></label>
            <input type="range" id="topK" min="1" max="100" step="1" value="40" style="width: 100%;"
                onchange="updateParam('top_k', parseInt(this.value))">
        </div>
    </div>
</div>

<!-- Promptæ¨¡æ¿ç®¡ç† -->
<div class="card" style="padding: 24px; margin-top: 24px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3>ğŸ“ Promptæ¨¡æ¿ç®¡ç†</h3>
        <button class="btn btn-primary btn-sm" onclick="showNewPromptModal()">+ æ–°å»ºæ¨¡æ¿</button>
    </div>

    <div class="card-grid" id="promptList">
        <div class="loading">
            <div class="spinner"></div>
        </div>
    </div>
</div>

<!-- Tokenç»Ÿè®¡ -->
<div class="card" style="padding: 24px; margin-top: 24px;">
    <h3 style="margin-bottom: 20px;">ğŸ“Š ä½¿ç”¨ç»Ÿè®¡</h3>

    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
        <div class="stat-card">
            <div class="stat-value" id="totalCalls">0</div>
            <div class="stat-label">è°ƒç”¨æ¬¡æ•°</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="totalCost">$0</div>
            <div class="stat-label">é¢„ä¼°æˆæœ¬</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="totalInputTokens">0</div>
            <div class="stat-label">è¾“å…¥Token</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="totalOutputTokens">0</div>
            <div class="stat-label">è¾“å‡ºToken</div>
        </div>
    </div>

    <button class="btn btn-secondary" style="width: 100%; margin-top: 20px;" onclick="resetUsage()">
        ğŸ”„ é‡ç½®ç»Ÿè®¡
    </button>
</div>
{% endblock %}

{% block scripts %}
<script>
    {% raw %}
    window.initPage = function () {
        loadSettings();
        loadParams();
        loadPrompts();
    };

    async function loadParams() {
        try {
            const { config } = await API.request('/api/settings/params');

            document.getElementById('temperature').value = config.temperature;
            document.getElementById('tempValue').textContent = config.temperature;

            document.getElementById('maxTokens').value = config.max_tokens;

            document.getElementById('topP').value = config.top_p;
            document.getElementById('topPValue').textContent = config.top_p;

            document.getElementById('topK').value = config.top_k;
            document.getElementById('topKValue').textContent = config.top_k;
        } catch (e) {
            console.error('åŠ è½½å‚æ•°å¤±è´¥', e);
        }
    }

    async function updateParam(key, value) {
        // æ›´æ–°æ˜¾ç¤º
        if (key === 'temperature') {
            document.getElementById('tempValue').textContent = value;
        } else if (key === 'top_p') {
            document.getElementById('topPValue').textContent = value;
        } else if (key === 'top_k') {
            document.getElementById('topKValue').textContent = value;
        }

        // å‘é€åˆ°åç«¯
        try {
            await API.request('/api/settings/params', {
                method: 'POST',
                body: { [key]: parseFloat(value) }
            });
        } catch (e) {
            console.error('æ›´æ–°å‚æ•°å¤±è´¥', e);
        }
    }

    async function applyPreset(name) {
        try {
            const { config } = await API.request('/api/settings/params/preset/' + name, {
                method: 'POST'
            });

            // æ›´æ–°UI
            document.getElementById('temperature').value = config.temperature;
            document.getElementById('tempValue').textContent = config.temperature;
            document.getElementById('maxTokens').value = config.max_tokens;
            document.getElementById('topP').value = config.top_p;
            document.getElementById('topPValue').textContent = config.top_p;
            document.getElementById('topK').value = config.top_k;
            document.getElementById('topKValue').textContent = config.top_k;

            showToast('å·²åº”ç”¨ ' + name + ' æ¨¡å¼');
        } catch (e) {
            console.error('åº”ç”¨é¢„è®¾å¤±è´¥', e);
        }
    }

    async function loadPrompts() {
        const container = document.getElementById('promptList');

        try {
            const { templates } = await API.request('/api/prompts');

            if (templates.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>æš‚æ— æ¨¡æ¿</p></div>';
                return;
            }

            container.innerHTML = templates.map(function (t) {
                return '<div class="card" style="padding: 16px;">' +
                    '<div class="card-header">' +
                    '<div class="card-title">' + t.name + '</div>' +
                    '<span class="card-badge">' + t.path.split('/')[0] + '</span>' +
                    '</div>' +
                    '<div style="font-size: 13px; color: var(--text-secondary); margin: 8px 0;">' +
                    t.preview.substring(0, 100) + '...' +
                    '</div>' +
                    '<div class="card-actions" style="margin-top: 12px; padding-top: 12px;">' +
                    '<button class="btn btn-sm btn-secondary" onclick="editPrompt(\'' + t.path + '\')">ç¼–è¾‘</button>' +
                    '</div>' +
                    '</div>';
            }).join('');

        } catch (e) {
            container.innerHTML = '<div class="empty-state"><p>åŠ è½½å¤±è´¥</p></div>';
        }
    }

    async function editPrompt(path) {
        try {
            const { content, variables } = await API.request('/api/prompts/' + path);

            var varsHtml = variables.length > 0
                ? '<p style="margin-bottom: 12px;">å˜é‡: ' + variables.map(function (v) { return '<code>{{' + v + '}}</code>'; }).join(', ') + '</p>'
                : '';

            showModal('ç¼–è¾‘æ¨¡æ¿: ' + path,
                varsHtml +
                '<textarea id="promptContent" class="form-textarea" style="min-height: 400px; font-family: monospace;">' + content + '</textarea>',
                '<button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>' +
                '<button class="btn btn-primary" onclick="savePromptEdit(\'' + path + '\')">ä¿å­˜</button>'
            );
        } catch (e) {
            showToast('åŠ è½½æ¨¡æ¿å¤±è´¥', 'error');
        }
    }

    async function savePromptEdit(path) {
        const content = document.getElementById('promptContent').value;

        try {
            await API.request('/api/prompts/' + path, {
                method: 'PUT',
                body: { content: content }
            });
            showToast('ä¿å­˜æˆåŠŸ');
            closeModal();
            loadPrompts();
        } catch (e) {
            showToast('ä¿å­˜å¤±è´¥', 'error');
        }
    }

    async function resetUsage() {
        try {
            await fetch('/api/settings/usage/reset', { method: 'POST' });
            showToast('ç»Ÿè®¡å·²é‡ç½®');
            loadSettings();
        } catch (e) {
            showToast('é‡ç½®å¤±è´¥', 'error');
        }
    }
    {% endraw %}
</script>
{% endblock %}